<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>对话取物机器人 - Web 控制界面</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background-color: #007bff;
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 1.8em;
        }

        .main-container {
            display: flex;
            flex-grow: 1;
            padding: 15px;
            gap: 15px;
            flex-wrap: wrap;
            /* 允许在高缩放或小屏幕时换行 */
        }

        .control-panel {
            flex: 2 1 500px;
            /* flex-grow, flex-shrink, flex-basis */
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 320px;
        }

        .status-panel {
            flex: 1 1 300px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            min-width: 280px;
        }

        .control-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .control-section h2 {
            margin-top: 0;
            font-size: 1.2em;
            color: #0056b3;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-start;
            margin-bottom: 10px;
        }

        .input-group {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .input-group label {
            white-space: nowrap;
            margin-right: 5px;
        }

        button,
        input[type="text"],
        input[type="number"],
        select {
            border: 1px solid #ccc;
            padding: 8px 12px;
            font-size: 0.95em;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        input[type="number"] {
            width: 80px;
        }

        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            min-width: 100px;
        }

        button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button:active {
            transform: translateY(0px);
            box-shadow: none;
        }

        button.red {
            background-color: #dc3545;
        }

        button.red:hover {
            background-color: #c82333;
        }

        button.yellow {
            background-color: #ffc107;
            color: #212529;
        }

        button.yellow:hover {
            background-color: #e0a800;
        }

        button.green {
            background-color: #28a745;
        }

        button.green:hover {
            background-color: #218838;
        }

        button.gray {
            background-color: #6c757d;
        }

        button.gray:hover {
            background-color: #5a6268;
        }

        .status-area,
        .info-box {
            margin-bottom: 8px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-size: 0.9em;
            word-break: break-all;
        }

        .info-box strong {
            color: #0056b3;
        }

        #logArea {
            margin-top: 10px;
            padding: 10px;
            background-color: #222;
            color: #eee;
            border-radius: 4px;
            height: 180px;
            overflow-y: scroll;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            border: none;
        }

        .camera-feed-container {
            text-align: center;
            margin-bottom: 15px;
        }

        .camera-feed {
            display: inline-block;
            max-width: 100%;
            height: auto;
            border: 2px solid #ddd;
            background-color: #000;
            border-radius: 4px;
        }

        .voice-input-section {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .voice-input-section input[type="text"] {
            flex-grow: 1;
            min-width: 150px;
        }

        .recognized-objects-list {
            list-style-type: none;
            padding-left: 0;
        }

        .recognized-objects-list li {
            background-color: #eef;
            padding: 5px;
            border-radius: 3px;
            margin-bottom: 3px;
            font-size: 0.85em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .recognized-objects-list li button {
            font-size: 0.8em;
            padding: 3px 6px;
            min-width: auto;
        }

        .footer {
            text-align: center;
            padding: 10px;
            font-size: 0.8em;
            color: #777;
            margin-top: auto;
        }

        .led-indicator-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
            padding: 5px 0;
        }

        .led {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #555;
            display: inline-block;
            margin: 0 5px;
            border: 1px solid #333;
            transition: background-color 0.3s;
        }

        .led.red.on {
            background-color: red;
            box-shadow: 0 0 10px red;
        }

        .led.green.on {
            background-color: limegreen;
            box-shadow: 0 0 10px limegreen;
        }

        .led.yellow.on {
            background-color: yellow;
            box-shadow: 0 0 10px yellow;
        }

        .led-label {
            font-size: 0.7em;
            text-align: center;
        }
    </style>
</head>

<body>
    <header class="header">
        <h1>对话取物机器人控制中心</h1>
    </header>

    <div class="main-container">
        <div class="control-panel">
            <div class="control-section camera-feed-container">
                <h2>摄像头实时画面</h2>
                <img id="cameraFeed" src="{{ url_for('video_feed') }}" class="camera-feed" alt="Camera Feed Loading..."
                    onerror="this.alt='Camera feed failed to load or not available.'; this.src='';">
            </div>

            <div class="control-section">
                <h2>语音交互 (模拟)</h2>
                <div class="voice-input-section">
                    <input type="text" id="voiceCommandInput" placeholder="输入模拟语音指令...">
                    <button onclick="sendVoiceCommand()">发送指令</button>
                    <button onclick="triggerRecordAudio()">开始录音 (硬件)</button>
                </div>
                <div class="info-box"><strong>识别文本:</strong> <span id="recognizedText">待识别...</span></div>
                <div class="info-box"><strong>语音反馈:</strong> <span id="voiceFeedback">系统就绪。</span></div>
            </div>

            <div class="control-section">
                <h2>机械臂手动控制</h2>
                <div class="button-group">
                    <button onclick="sendCommandToBackend('manual_x_plus')">X+</button>
                    <button onclick="sendCommandToBackend('manual_y_plus')">Y+</button>
                    <button onclick="sendCommandToBackend('manual_z_plus')">Z+</button>
                </div>
                <div class="button-group">
                    <button onclick="sendCommandToBackend('manual_x_minus')">X-</button>
                    <button onclick="sendCommandToBackend('manual_y_minus')">Y-</button>
                    <button onclick="sendCommandToBackend('manual_z_minus')">Z-</button>
                </div>
                <div class="button-group">
                    <button class="red" onclick="sendCommandToBackend('manual_reset')">复位机械臂</button>
                </div>
                <hr>
                <div class="button-group">
                    <button class="green" onclick="sendCommandToBackend('pump_on')">启动吸泵</button>
                    <button class="red" onclick="sendCommandToBackend('pump_off')">停止吸泵</button>
                </div>
                <div class="input-group">
                    <label for="pumpAngleInput">旋转头角度 (0° to 180°):</label>
                    <input type="number" id="pumpAngleInput" name="pumpAngle" min="0" max="180" value="0" step="5">
                    <button onclick="setPumpAngle()">设定角度</button>
                </div>
                <div class="button-group">
                    <button onclick="sendCommandToBackend('pump_rotate_left_small')">左旋小幅 (-15°)</button>
                    <button onclick="sendCommandToBackend('pump_rotate_right_small')">右旋小幅 (+15°)</button>
                </div>
            </div>

            <div class="control-section">
                <h2>任务与轨迹控制 (通过STM32 LED)</h2>
                <div class="info-box">
                    <strong>STM32 LED 状态:</strong>
                    <div class="led-indicator-container">
                        <div><span id="ledRed" class="led red"></span>
                            <div class="led-label">红</div>
                        </div>
                        <div><span id="ledGreen" class="led green"></span>
                            <div class="led-label">绿</div>
                        </div>
                        <div><span id="ledYellow" class="led yellow"></span>
                            <div class="led-label">黄</div>
                        </div>
                    </div>
                    <span id="stm32LightStatusText">未知</span>
                </div>
                <div class="button-group">
                    <button class="green" onclick="sendCommandToBackend('set_green_on')">启动/重启轨迹 (绿灯)</button>
                    <button class="yellow" onclick="sendCommandToBackend('set_yellow_on')">继续/恢复轨迹 (黄灯)</button>
                </div>
                <div class="button-group">
                    <button class="red" onclick="sendCommandToBackend('set_red_on')">停止&复位 (红灯)</button>
                    <button class="gray" onclick="sendCommandToBackend('set_lights_off')">暂停轨迹 (灯灭)</button>
                </div>
                <div class="button-group">
                    <button onclick="sendCommandToBackend('task_pause')">行为暂停 (软)</button>
                    <button onclick="sendCommandToBackend('task_stop')">行为停止 (软)</button>
                    <button onclick="sendCommandToBackend('task_continue')">行为继续 (软)</button>
                </div>
            </div>
            <div class="control-section">
                <h2>操作日志</h2>
                <div id="logArea">日志将显示在这里...\n</div>
            </div>
        </div>

        <aside class="status-panel">
            <h2>系统状态与信息</h2>
            <div class="info-box"><strong>机械臂主状态:</strong> <span id="armMainState">IDLE</span></div>
            <div class="info-box"><strong>当前轨迹点:</strong> <span id="trajectoryInfo">N/A</span></div>

            <div class="control-section">
                <h3>物体识别结果 (示例)</h3>
                <ul id="recognizedObjectsList" class="recognized-objects-list">
                    <li>苹果 (红色) - 坐标: [x,y,z] <button onclick="pickObject('apple_red_id_123')">拾取</button></li>
                    <li>杯子 (蓝色) - 坐标: [x,y,z] <button onclick="pickObject('cup_blue_id_456')">拾取</button></li>
                    <li>书本 - 坐标: [x,y,z] <button onclick="pickObject('book_id_789')">拾取</button></li>
                    <!-- 更多物体将由JS动态添加 -->
                </ul>
                <div class="info-box"><strong>任务目标物体:</strong> <span id="targetObjectInfo">未指定</span></div>
                <div class="info-box"><strong>任务目标位置:</strong> <span id="targetLocationInfo">未指定</span></div>
            </div>

            <div class="control-section">
                <h3>机械臂详细状态</h3>
                <div class="info-box"><strong>末端坐标:</strong> <span id="armCoords">[X, Y, Z, A, B, C]</span></div>
                <!-- <div class="info-box"><strong>关节角度:</strong> <span id="armJoints">[J1, J2, J3, J4, J5, J6]</span></div> -->
                <div class="info-box"><strong>吸泵状态:</strong> <span id="pumpStatus">OFF</span></div>
                <div class="info-box"><strong>旋转头角度:</strong> <span id="pumpAngleDisplay">0°</span></div>
            </div>

            <div class="control-section">
                <h3>系统消息与提示</h3>
                <div id="systemMessages" class="info-box" style="min-height: 60px; background-color: #e2f3ff;">
                    请发出语音指令或使用界面操作。</div>
            </div>
        </aside>
    </div>

    <footer class="footer">
        <p>© 2024-2025 对话取物机器人项目</p>
    </footer>

    <script>
        function sendCommandToBackend(command, payload = {}) {
            addToLog('发送指令到后端: ' + command + (Object.keys(payload).length ? ' Payload: ' + JSON.stringify(payload) : ''));
            fetch('/control', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', },
                body: JSON.stringify({ command: command, payload: payload }),
            })
                .then(response => {
                    if (!response.ok) {
                        // 对于非2xx的响应，也尝试读取json错误信息
                        return response.json().then(errData => {
                            throw new Error(errData.message || `HTTP error ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    addToLog('后端响应: ' + JSON.stringify(data));
                    if (data.message) {
                        updateSystemMessage(data.message, data.status === 'error' ? 'error' : 'info');
                    }
                    updateFullStatus();
                })
                .catch((error) => {
                    const errorMessage = error.message || '与后端通信发生未知错误。';
                    addToLog('指令错误: ' + errorMessage);
                    updateSystemMessage('与后端通信失败: ' + errorMessage, 'error');
                    console.error('Error during command fetch:', error);
                });
        }

        function updateFullStatus() {
            fetch('/status')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('armMainState').textContent = data.arm_state || '未知';

                    const lightStatusText = data.stm32_light_status || '未知';
                    document.getElementById('stm32LightStatusText').textContent = lightStatusText;
                    updateLedIndicators(lightStatusText);

                    const trajIndex = data.current_trajectory_index !== undefined ? data.current_trajectory_index : -1;
                    const totalPoints = data.total_trajectory_points || 0;
                    if (data.arm_state === 'RUNNING_TRAJECTORY' || data.arm_state === 'PAUSED_TRAJECTORY') {
                        document.getElementById('trajectoryInfo').textContent = `${trajIndex + 1} / ${totalPoints}`;
                    } else {
                        document.getElementById('trajectoryInfo').textContent = 'N/A';
                    }

                    document.getElementById('armCoords').textContent = data.arm_coords || '[X, Y, Z, A, B, C]';
                    // document.getElementById('armJoints').textContent = data.arm_joints || '[J1, J2, J3, J4, J5, J6]';

                    document.getElementById('pumpStatus').textContent = data.pump_status || 'OFF';
                    document.getElementById('pumpAngleDisplay').textContent = (data.pump_angle !== undefined ? data.pump_angle : '0') + '°';

                    // 动态更新物体识别列表 (原型)
                    const objectsListEl = document.getElementById('recognizedObjectsList');
                    // objectsListEl.innerHTML = ''; // 清空，如果需要完全动态
                    // if (data.recognized_objects && data.recognized_objects.length > 0) {
                    //     data.recognized_objects.forEach(obj => {
                    //         const li = document.createElement('li');
                    //         li.innerHTML = `${obj.name} (${obj.color || 'N/A'}) - Pos: [${obj.x},${obj.y},${obj.z}] <button onclick="pickObject('${obj.id}')">拾取</button>`;
                    //         objectsListEl.appendChild(li);
                    //     });
                    // } else {
                    //     // objectsListEl.innerHTML = '<li>未识别到物体</li>'; // 如果列表为空
                    // }
                    document.getElementById('targetObjectInfo').textContent = data.target_object || '未指定';
                    document.getElementById('targetLocationInfo').textContent = data.target_location || '未指定';
                })
                .catch((error) => {
                    addToLog('获取状态错误: ' + error.message);
                    updateSystemMessage('获取系统状态失败: ' + error.message, 'error');
                    console.error('Error fetching status:', error);
                });
        }

        function updateLedIndicators(statusText) {
            const leds = {
                red: document.getElementById('ledRed'),
                green: document.getElementById('ledGreen'),
                yellow: document.getElementById('ledYellow')
            };
            for (let color in leds) {
                leds[color].classList.remove('on');
            }
            if (statusText === "RED_ON") leds.red.classList.add('on');
            else if (statusText === "GREEN_ON") leds.green.classList.add('on');
            else if (statusText === "YELLOW_ON") leds.yellow.classList.add('on');
        }

        function addToLog(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            logArea.value += `[${timestamp}] ${message}\n`; // Use .value for textarea, or .innerHTML for div
            logArea.scrollTop = logArea.scrollHeight;
        }

        function updateSystemMessage(message, type = 'info') {
            const msgArea = document.getElementById('systemMessages');
            msgArea.textContent = message;
            const colors = {
                info: { bg: '#e2f3ff', text: '#0c5460' },
                error: { bg: '#f8d7da', text: '#721c24' },
                success: { bg: '#d4edda', text: '#155724' }
            };
            msgArea.style.backgroundColor = colors[type].bg;
            msgArea.style.color = colors[type].text;
        }

        function sendVoiceCommand() {
            const commandText = document.getElementById('voiceCommandInput').value;
            if (!commandText.trim()) { updateSystemMessage('请输入模拟语音指令。', 'error'); return; }
            addToLog('模拟语音指令: ' + commandText);
            sendCommandToBackend('process_voice_text', { text: commandText });
            document.getElementById('recognizedText').textContent = commandText + " (等待后端解析...)";
            updateSystemMessage('模拟语音指令已发送处理...', 'info');
        }

        function triggerRecordAudio() {
            addToLog('请求硬件录音...');
            sendCommandToBackend('start_hardware_voice_recognition');
            updateSystemMessage('硬件录音请求已发送...', 'info');
            document.getElementById('recognizedText').textContent = "正在录音/识别...";
        }

        function pickObject(objectId) { // objectId 应该是唯一的标识
            addToLog('请求拾取物体: ' + objectId);
            sendCommandToBackend('pick_object_by_id', { id: objectId });
            updateSystemMessage('拾取指令已发送: ' + objectId, 'info');
        }

        function setPumpAngle() {
            const angleInput = document.getElementById('pumpAngleInput');
            const angle = parseInt(angleInput.value);
            if (isNaN(angle) || angle < 0 || angle > 180) {
                updateSystemMessage('请输入有效的旋转角度 (0 到 180)。', 'error');
                angleInput.focus();
                return;
            }
            addToLog('设定旋转头角度: ' + angle + '°');
            sendCommandToBackend('pump_angle_set', { angle: angle });
        }

        document.addEventListener('DOMContentLoaded', function () {
            // 将日志区域改为 textarea 以支持 .value 和滚动
            const logAreaDiv = document.getElementById('logArea');
            const logAreaTextarea = document.createElement('textarea');
            logAreaTextarea.id = 'logArea';
            logAreaTextarea.readOnly = true;
            logAreaTextarea.style.cssText = logAreaDiv.style.cssText; // 复制样式
            logAreaTextarea.style.whiteSpace = 'pre-wrap'; // 确保textarea也换行
            logAreaDiv.parentNode.replaceChild(logAreaTextarea, logAreaDiv);

            updateFullStatus();
            setInterval(updateFullStatus, 3000);
            addToLog("Web UI 已加载，开始与后端通信...");
            updateSystemMessage("就绪，等待操作或语音指令。");
        });
    </script>
</body>

</html>